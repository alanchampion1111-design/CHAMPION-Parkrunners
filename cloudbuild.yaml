options:
  logging: CLOUD_LOGGING_ONLY
  
steps:
  # Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t',
      'europe-west1-docker.pkg.dev/parkrun-champions/cloud-run-source-deploy/browser-automation-service',
      '.'
    ]

  # Deploy to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args: [ 'run','deploy','browser-automation-service',
            '--image=europe-west1-docker.pkg.dev/parkrun-champions/cloud-run-source-deploy/browser-automation-service',
            '--platform=managed','--allow-unauthenticated','--port=8080',
            '--region=global','--set-env-vars=^:^NODE_ENV=production',
            '--memory=2Gi','--cpu=1','--min-instances=0','--max-instances=1'
          ]

  # Debug: List /app contents
  - name: 'gcr.io/cloud-builders/docker'
    args: ['run','--rm','--entrypoint',
            'ls','europe-west1-docker.pkg.dev/parkrun-champions/cloud-run-source-deploy/browser-automation-service','-la','/app'
          ]
    id: 'debug-app-contents'

# Store the image in Artifact Registry
images:
  - 'europe-west1-docker.pkg.dev/parkrun-champions/cloud-run-source-deploy/browser-automation-service'
